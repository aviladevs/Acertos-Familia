<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processador de Extratos - Avila Transportes</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f5f5f7; color: #1d1d1f; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #007aff; margin-bottom: 30px; }
        h2 { color: #1d1d1f; margin-bottom: 15px; border-bottom: 2px solid #007aff; padding-bottom: 5px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 24px; font-weight: bold; color: #007aff; }
        .stat-label { font-size: 14px; color: #666; margin-top: 5px; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #007aff; color: white; font-weight: 600; }
        tr:nth-child(even) { background: #f9f9f9; }
        .cnpj { font-family: monospace; background: #e3f2fd; padding: 2px 4px; border-radius: 3px; }
        .valor-positivo { color: #28a745; font-weight: bold; }
        .valor-negativo { color: #dc3545; font-weight: bold; }
        .empresa { font-weight: 600; color: #007aff; }
    </style>
</head>
<body>
    <div class="container">
        <h1> Análise de Extratos - Centro de Custo</h1>
        
        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="totalEmpresas">0</div>
                <div class="stat-label">Empresas Identificadas</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="totalTransacoes">0</div>
                <div class="stat-label">Total de Transações</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="valorTotal">R$ 0,00</div>
                <div class="stat-label">Valor Total Movimentado</div>
            </div>
        </div>

        <div class="card">
            <h2> Extrato Inter (Conta: 431913919)</h2>
            <div id="interResults"></div>
        </div>

        <div class="card">
            <h2> Extrato Nubank (Conta: 100275573)</h2>
            <div id="nubankResults"></div>
        </div>

        <div class="card">
            <h2> Resumo por Cliente/CNPJ</h2>
            <div id="resumoClientes"></div>
        </div>
    </div>

    <script>
        // Dados do extrato Inter processados
        const extratoInter = `15/03/2025;Pix recebido: "Cp :00000000-RENATO AVILA BARROS";600,00;600,00
16/03/2025;Pix enviado: "Cp :18236120-Alceu Rodrigues Neto";-400,00;200,00
17/03/2025;Pix recebido: "00019 219817430 LZP COMERCIAL LTDA";60,00;260,00
17/03/2025;Pix enviado: "Cp :18236120-AVILA TRANSPORTES INTERMUNICIPAL LTDA";-200,00;60,00
20/03/2025;Pix enviado: "Cp :18236120-AVILA TRANSPORTES INTERMUNICIPAL LTDA";-607,00;-547,00
20/03/2025;Pix recebido: "Cp :90400888-NARDINI AGROINDUSTRIAL LTDA";551,89;4,89
21/03/2025;Pix enviado: "Cp :18236120-AVILA TRANSPORTES INTERMUNICIPAL LTDA";-4,89;-0,00
31/03/2025;Pix enviado: "Cp :18236120-Avila Transportes Intermunicipal LTDA";-290,00;-290,00
31/03/2025;Transferencia recebida: "341 9 147786 NARDINI AGROINDUSTRIAL LTDA";220,00;-70,00
31/03/2025;Transferencia recebida: "033 3 130105157 NARDINI AGROINDUSTRIAL LTDA";70,00;-0,00`;

        // Dados do extrato Nubank processados (amostra)
        const extratoNubank = `02/01/2025,120.00,Transferência recebida pelo Pix - VIVIANE E SILVA ROTIROTI - 11.637.582/0001-38
02/01/2025,50.00,Transferência recebida pelo Pix - Agro Vallen Pecas Agricolas Ltda - 36.177.784/0001-75
02/01/2025,954.00,Transferência Recebida - ALAN BELUZI 38875959803 - 26.652.823/0001-95
02/01/2025,280.00,Transferência recebida pelo Pix - DV4 do Brasil - 68.327.162/0001-72
02/01/2025,-800.00,Transferência enviada pelo Pix - Lh Transporte e Logistica - 35.148.026/0001-66
02/01/2025,-9.60,Transferência enviada pelo Pix - TRANSBRASILIANA CONCESSIONARIA DE RODOVIA SA - 09.074.183/0001-64
02/01/2025,-145.00,Transferência enviada pelo Pix - C H L SILVA PASTELARIA  ME - 16.502.081/0001-68
03/01/2025,149.99,Transferência recebida pelo Pix - M. D. INDUSTRIA QUIMICA LTDA - EPP - 55.962.179/0001-50
03/01/2025,52.00,Transferência recebida pelo Pix - FABRO ELETRICA E AR CONDICIONADO AUTOMOTIVO LTDA - 19.953.242/0001-28
03/01/2025,48.00,Transferência recebida pelo Pix - TRACKMAX COMERCIO DE PECAS E SERVICOS LTDA - 13.985.861/0001-18
03/01/2025,-73.00,Transferência enviada pelo Pix - Drogaria Lealdade Amizade Ltda Me - 45.301.772/0001-00
06/01/2025,90.00,Transferência recebida pelo Pix - MASTER PRINT 017 LTDA - 48.676.056/0001-97`;

        let clientesMap = new Map();
        let totalTransacoes = 0;
        let valorTotalMovimentado = 0;

        function extrairCNPJ(texto) {
            // Regex para CNPJ nos formatos: XX.XXX.XXX/XXXX-XX ou XXXXXXXXXXXXXXXX
            const cnpjRegex = /(\d{2}\.?\d{3}\.?\d{3}\/?\d{4}-?\d{2})/;
            const match = texto.match(cnpjRegex);
            return match ? match[0] : null;
        }

        function limparNomeEmpresa(texto, cnpj) {
            let nome = texto
                // Remove prefixos comuns
                .replace(/Pix (recebido|enviado):/gi, '')
                .replace(/Transferencia (recebida|enviada):/gi, '')
                .replace(/Transferência (recebida|enviada) pelo Pix\s*-?/gi, '')
                .replace(/Transferência Recebida\s*-?/gi, '')
                .replace(/Cp\s*:\s*\d+\s*-?/gi, '')
                .replace(/^\d+\s+\d+\s+\d+\s+/gi, '') // Remove códigos iniciais como "341 9 147786"
                .replace(/^\d+\s+/gi, '') // Remove números iniciais
                .replace(/"/g, '') // Remove aspas
                .trim();

            // Remove o CNPJ do texto se encontrado
            if (cnpj) {
                // Remove CNPJ com formatação
                nome = nome.replace(new RegExp(cnpj.replace(/[.\/\-]/g, '\\\\$&'), 'gi'), '');
                // Remove CNPJ sem formatação (14 dígitos)
                const cnpjNumeros = cnpj.replace(/[^\d]/g, '');
                nome = nome.replace(new RegExp(cnpjNumeros, 'gi'), '');
                // Remove traços isolados que sobraram
                nome = nome.replace(/\s*-\s*$/, '').replace(/^\s*-\s*/, '');
            }

            // Remove datas no formato DD/MM/AAAA
            nome = nome.replace(/\d{2}\/\d{2}\/\d{4}/g, '');
            
            // Remove CPF mascarado (.XXX.XXX-)
            nome = nome.replace(/{3}\.\d{3}\.\d{3}-{2}/g, '');
            
            // Remove números de CPF completos
            nome = nome.replace(/\d{11}/g, '');
            
            // Remove informações bancárias (padrão: BANCO (XXXX) Agência: XXX Conta: XXX)
            nome = nome.replace(/\s*-\s*[A-Z\s]+(SCFI|S\.?A\.?|LTDA|ME|EPP)?\s*\(\d+\)\s*Agência:\s*\d+\s*Conta:\s*[\d\-]+/gi, '');
            
            // Remove apenas informações bancárias sem hífen inicial
            nome = nome.replace(/\s*[A-Z\s]+(SCFI|S\.?A\.?|LTDA|ME|EPP)?\s*\(\d+\)\s*Agência:\s*\d+\s*Conta:\s*[\d\-]+/gi, '');
            
            // Remove espaços múltiplos e trim
            nome = nome.replace(/\s+/g, ' ').trim();
            
            // Remove hífen no final ou início
            nome = nome.replace(/^-\s*/, '').replace(/\s*-$/, '');
            
            // Capitaliza o nome corretamente
            nome = nome.toLowerCase().split(' ')
                .map(palavra => palavra.charAt(0).toUpperCase() + palavra.slice(1))
                .join(' ');

            return nome || 'Nome não identificado';
        }

        function formatarValor(valor) {
            const num = parseFloat(valor.toString().replace(',', '.'));
            return new Intl.NumberFormat('pt-BR', { 
                style: 'currency', 
                currency: 'BRL' 
            }).format(Math.abs(num));
        }

        function processarExtratoInter() {
            const linhas = extratoInter.split('\\n');
            let resultados = [];

            linhas.forEach(linha => {
                if (!linha.trim()) return;
                
                const partes = linha.split(';');
                if (partes.length >= 3) {
                    const data = partes[0];
                    const descricao = partes[1];
                    const valor = partes[2];
                    
                    const cnpj = extrairCNPJ(descricao);
                    
                    if (cnpj) {
                        const nomeEmpresa = limparNomeEmpresa(descricao, cnpj);
                        
                        if (nomeEmpresa !== 'Nome não identificado') {
                            const key = `${cnpj}_${nomeEmpresa}`;
                            if (!clientesMap.has(key)) {
                                clientesMap.set(key, {
                                    nome: nomeEmpresa,
                                    cnpj: cnpj,
                                    transacoes: [],
                                    totalRecebido: 0,
                                    totalEnviado: 0
                                });
                            }
                            
                            const cliente = clientesMap.get(key);
                            const valorNum = parseFloat(valor.replace(',', '.'));
                            
                            cliente.transacoes.push({
                                data: data,
                                descricao: descricao,
                                valor: valorNum,
                                banco: 'Inter'
                            });
                            
                            if (valorNum > 0) {
                                cliente.totalRecebido += valorNum;
                            } else {
                                cliente.totalEnviado += Math.abs(valorNum);
                            }
                            
                            totalTransacoes++;
                            valorTotalMovimentado += Math.abs(valorNum);
                            
                            resultados.push({
                                data, nomeEmpresa, cnpj, valor: valorNum, descricao
                            });
                        }
                    }
                }
            });

            return resultados;
        }

        function processarExtratoNubank() {
            const linhas = extratoNubank.split('\\n');
            let resultados = [];

            linhas.forEach(linha => {
                if (!linha.trim()) return;
                
                const partes = linha.split(',');
                if (partes.length >= 3) {
                    const data = partes[0];
                    const valor = partes[1];
                    const descricao = partes[2];
                    
                    const cnpj = extrairCNPJ(descricao);
                    
                    if (cnpj) {
                        const nomeEmpresa = limparNomeEmpresa(descricao, cnpj);
                        
                        if (nomeEmpresa !== 'Nome não identificado') {
                            const key = `${cnpj}_${nomeEmpresa}`;
                            if (!clientesMap.has(key)) {
                                clientesMap.set(key, {
                                    nome: nomeEmpresa,
                                    cnpj: cnpj,
                                    transacoes: [],
                                    totalRecebido: 0,
                                    totalEnviado: 0
                                });
                            }
                            
                            const cliente = clientesMap.get(key);
                            const valorNum = parseFloat(valor);
                            
                            cliente.transacoes.push({
                                data: data,
                                descricao: descricao,
                                valor: valorNum,
                                banco: 'Nubank'
                            });
                            
                            if (valorNum > 0) {
                                cliente.totalRecebido += valorNum;
                            } else {
                                cliente.totalEnviado += Math.abs(valorNum);
                            }
                            
                            totalTransacoes++;
                            valorTotalMovimentado += Math.abs(valorNum);
                            
                            resultados.push({
                                data, nomeEmpresa, cnpj, valor: valorNum, descricao
                            });
                        }
                    }
                }
            });

            return resultados;
        }

        function renderizarTabela(dados, containerId) {
            if (dados.length === 0) {
                document.getElementById(containerId).innerHTML = '<p>Nenhuma empresa com CNPJ identificada.</p>';
                return;
            }

            let html = `<table>
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Empresa</th>
                        <th>CNPJ</th>
                        <th>Valor</th>
                        <th>Tipo</th>
                    </tr>
                </thead>
                <tbody>`;

            dados.forEach(item => {
                const valorClass = item.valor >= 0 ? 'valor-positivo' : 'valor-negativo';
                const tipo = item.valor >= 0 ? 'Recebido' : 'Enviado';
                
                html += `<tr>
                    <td>${item.data}</td>
                    <td class="empresa">${item.nomeEmpresa}</td>
                    <td><span class="cnpj">${item.cnpj}</span></td>
                    <td class="${valorClass}">${formatarValor(item.valor)}</td>
                    <td>${tipo}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            document.getElementById(containerId).innerHTML = html;
        }

        function renderizarResumoClientes() {
            if (clientesMap.size === 0) {
                document.getElementById('resumoClientes').innerHTML = '<p>Nenhum cliente identificado.</p>';
                return;
            }

            let html = `<table>
                <thead>
                    <tr>
                        <th>Empresa</th>
                        <th>CNPJ</th>
                        <th>Transações</th>
                        <th>Total Recebido</th>
                        <th>Total Enviado</th>
                        <th>Saldo</th>
                    </tr>
                </thead>
                <tbody>`;

            // Converter Map para Array e ordenar por total movimentado
            const clientes = Array.from(clientesMap.values())
                .sort((a, b) => (b.totalRecebido + b.totalEnviado) - (a.totalRecebido + a.totalEnviado));

            clientes.forEach(cliente => {
                const saldo = cliente.totalRecebido - cliente.totalEnviado;
                const saldoClass = saldo >= 0 ? 'valor-positivo' : 'valor-negativo';
                
                html += `<tr>
                    <td class="empresa">${cliente.nome}</td>
                    <td><span class="cnpj">${cliente.cnpj}</span></td>
                    <td>${cliente.transacoes.length}</td>
                    <td class="valor-positivo">${formatarValor(cliente.totalRecebido)}</td>
                    <td class="valor-negativo">${formatarValor(cliente.totalEnviado)}</td>
                    <td class="${saldoClass}">${formatarValor(saldo)}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            document.getElementById('resumoClientes').innerHTML = html;
        }

        function atualizarEstatisticas() {
            document.getElementById('totalEmpresas').textContent = clientesMap.size;
            document.getElementById('totalTransacoes').textContent = totalTransacoes;
            document.getElementById('valorTotal').textContent = formatarValor(valorTotalMovimentado);
        }

        // Processar os dados
        document.addEventListener('DOMContentLoaded', function() {
            const interResults = processarExtratoInter();
            const nubankResults = processarExtratoNubank();
            
            renderizarTabela(interResults, 'interResults');
            renderizarTabela(nubankResults, 'nubankResults');
            renderizarResumoClientes();
            atualizarEstatisticas();
        });
    </script>
</body>
</html>
